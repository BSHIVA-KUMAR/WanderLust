<% layout("/layouts/boilerplate") %>
<script>
  const mapToken = "<%= locals.mapToken || '' %>";
  const listing = <%- JSON.stringify(listing) %>;
</script>
<style>
  #map {
    height: 400px;
    width: 100%;
    border-radius: 10px;
    margin-top: 1rem;
  }
</style>
<div class="row mt-3">
  <div class="col-8 offset-3">
    <h3><b><%= listing.title %></b></h3>
  </div>
  <div class="card col-6 offset-3 show-card listing-card">
    <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="listing_image">
    <div class="card-body">
      <p class="card-text"><br><i> Owned By: <%= listing.owner.username %></i></p>
      <p class="card-text"><%= listing.description %> </p>
      <p class="card-text text-primary">Price:&ensp; &#8377; <%= listing.price.toLocaleString("en-IN") %> </p>
      <p class="card-text"><%= listing.location %> </p>
      <p class="card-text"><%= listing.country %> </p>
      <p class="card-text fa-brands text-danger"><b>Category: </b> <%= listing.category %></p>
    </div>
  </div>

  <br />
  <% if (currUser && currUser._id.equals(listing.owner._id)) { %>
    <div class="btns">
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark col-1 offset-3 edit-btn">Edit</a>
      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
        <button class="btn btn-dark offset-5">Delete</button>
      </form>
      
    </div>
    
    <!-- <div class="col-8 offset-3 mb-3">
      <hr>
      <h3>Where you'll be?</h3>
      <div id="map"></div>
    </div> -->
    <div class="col-8 offset-3 mb-3">
      <hr>
      <h4>Bookings</h4>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>Name</th>
      <th>Aadhar Number</th>
      <th>Date of Booking</th>
      <th>Date of Exit</th>
    </tr>
  </thead>
  <tbody>
    <% listing.bookings.forEach(booking => { %>
      <tr>
        <td><%= booking.name %></td>
        <td><%= booking.aadharNumber %></td>
        <td><%= new Date(booking.dateOfBooking).toDateString() %></td>
        <td><%= new Date(booking.dateOfExit).toDateString() %></td>
      </tr>
    <% }) %>
  </tbody>
</table>

    </div>
  <% } else if (currUser) { %>
    <div class="col-8 offset-3 mb-3">
      <a href="/listings/<%= listing._id %>/book" class="btn btn-primary">Book this Listing</a>
    </div>
  <% } %>

  <div class="col-8 offset-3 mb-3">
    <hr>
    <% if (currUser) { %>
      <h4>Leave a Review...</h4>
      <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation">
        <div class="md-3 mt-3">
          <label for="review[rating]" class="form-label">Rating</label>
          <fieldset class="starability-slot">
            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
            <input type="radio" id="first-rate1" name="review[rating]" value="1" />
            <label for="first-rate1" title="Terrible">1 star</label>
            <input type="radio" id="first-rate2" name="review[rating]" value="2" />
            <label for="first-rate2" title="Not good">2 stars</label>
            <input type="radio" id="first-rate3" name="review[rating]" value="3" />
            <label for="first-rate3" title="Average">3 stars</label>
            <input type="radio" id="first-rate4" name="review[rating]" value="4" />
            <label for="first-rate4" title="Very good">4 stars</label>
            <input type="radio" id="first-rate5" name="review[rating]" value="5" />
            <label for="first-rate5" title="Amazing">5 stars</label>
          </fieldset>
        </div>
        <div class="mb-3 mt-3">
          <label for="comment" class="form-label">Comments</label>
          <textarea 
            name="review[comment]" 
            id="comment" 
            rows="5"
            cols="30"
            class="form-control"
            required       
          ></textarea>
          <div class="invalid-feedback">Please add some comments for review</div>
        </div>
        <div>
          <button class="btn btn-outline-dark">Submit</button>
        </div>
      </form>
      <!-- <hr/> -->
    <% } %>
   
    <!-- display reviews only if exists -->
  <% if(listing.reviews && listing.reviews.length > 0) { %>
    <div class="row">
      <p><b>All Reviews</b></p>
      <% listing.reviews.forEach(review => { %>
        <% if (review && review._id) { %>
          <div class="card col-5 ms-3 mb-3">
            <div class="card-body">
              <h5 class="card-title">@<%= review.author ? review.author.username : 'Anonymous' %></h5>
              <p class="starability-result card-text" data-rating="<%= review.rating || 0 %>"></p>
              <p class="card-text"><%= review.comment || 'No comment' %></p>
              <% if (currUser && review.author && currUser._id.equals(review.author._id)) { %>
                <form 
                  class="mb-3"
                  method="POST"
                  action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                  <button class="btn btn-sm btn-dark">Delete</button>
                </form>
              <% } %>
            </div>
          </div>
        <% } %>
      <% }) %>
    </div>
    <% } %>
  </div>
  
  <div class="col-8 offset-3 mb-3">
    <hr>
    <h3>Where you'll be?</h3>
    <% if (listing.geometry && listing.geometry.coordinates && Array.isArray(listing.geometry.coordinates) && listing.geometry.coordinates.length === 2) { %>
      <div id="map"></div>
      <div id="map-placeholder" style="display: none; text-align: center; padding: 2rem; background-color: #f8f9fa; border-radius: 10px; margin-top: 1rem;">
        <i class="fas fa-map-marked-alt" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
        <p class="text-muted">Map is loading...</p>
        <p class="text-muted small">If the map doesn't appear, please ensure MAP_TOKEN is set in your .env file.</p>
      </div>
    <% } else { %>
      <div style="text-align: center; padding: 2rem; background-color: #f8f9fa; border-radius: 10px;">
        <i class="fas fa-map-marked-alt" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
        <p class="text-muted">Location map is not available for this listing.</p>
        <p class="text-muted small">The listing location: <strong><%= listing.location %>, <%= listing.country %></strong></p>
      </div>
    <% } %>
  </div>
</div>

<script>
  // Wait for mapboxgl to be available
  function initMap() {
    if (typeof mapboxgl === 'undefined') {
      setTimeout(initMap, 100);
      return;
    }

    const mapContainer = document.getElementById('map');
    const mapPlaceholder = document.getElementById('map-placeholder');
    
    if (mapToken && mapToken.trim() !== '' && typeof listing !== 'undefined' && listing && listing.geometry && listing.geometry.coordinates && Array.isArray(listing.geometry.coordinates) && listing.geometry.coordinates.length === 2) {
      try {
        mapboxgl.accessToken = mapToken;
        
        const map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: listing.geometry.coordinates,
          zoom: 9
        });

        map.on('load', function() {
          const marker = new mapboxgl.Marker({ color: "red" })
            .setLngLat(listing.geometry.coordinates)
            .setPopup(new mapboxgl.Popup({ offset: 25 })
              .setHTML(`<h4>${listing.title}</h4><p>${listing.location}</p>`))
            .addTo(map);
          
          // Hide placeholder if map loads successfully
          if (mapPlaceholder) {
            mapPlaceholder.style.display = 'none';
          }
        });

        map.on('error', function(e) {
          console.error('Map error:', e);
          showMapError();
        });
      } catch(error) {
        console.error('Map initialization error:', error);
        showMapError();
      }
    } else {
      showMapError();
    }

    function showMapError() {
      if (mapContainer) {
        mapContainer.innerHTML = `
          <div style="text-align: center; padding: 2rem; background-color: #fff3cd; border-radius: 10px; border: 1px solid #ffc107;">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #856404; margin-bottom: 1rem;"></i>
            <p class="text-warning"><strong>Map unavailable</strong></p>
            <p class="text-muted small">Location: <strong>${listing.location}, ${listing.country}</strong></p>
            <p class="text-muted small">Please ensure MAP_TOKEN is set in your .env file to view the map.</p>
          </div>
        `;
      }
      if (mapPlaceholder) {
        mapPlaceholder.style.display = 'none';
      }
    }
  }

  // Start initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }
</script>
<link rel="stylesheet" href="/path/to/starability.css">
